<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<title>Mats Body Reset â€“ Daily Tracker (v7b)</title>
<style>
  :root{--bg:#0f172a;--panel:#111827EE;--muted:#94a3b8;--text:#e5e7eb;--accent:#22d3ee;--accent2:#a78bfa;--ok:#34d399;--warn:#f59e0b;--danger:#f87171;--border:#1f2937}
  body.theme-dark{--bg:#0f172a;--panel:#111827EE;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937;--accent:#22d3ee;--accent2:#a78bfa;background:radial-gradient(1200px 800px at 20% 0%, #0b1228 0%, #0f172a 50%, #0a0f22 100%);color:var(--text)}
  body.theme-light{--bg:#f8fafc;--panel:#ffffff;--text:#0f172a;--muted:#475569;--border:#e2e8f0;--accent:#0ea5e9;--accent2:#6366f1;background:linear-gradient(180deg,#f8fafc,#f1f5f9);color:var(--text)}
  body.theme-bright{--bg:#0a0a0a;--panel:#ffffff;--text:#0a0a0a;--muted:#374151;--border:#111827;--accent:#16a34a;--accent2:#22d3ee;background:linear-gradient(180deg,#ffffff,#f4f4f5);color:var(--text)}
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto} 
  header{position:sticky;top:0;z-index:50;backdrop-filter:blur(8px);background:linear-gradient(180deg, rgba(2,6,23,.75), rgba(2,6,23,.3));border-bottom:1px solid var(--border);
    padding:.55rem 1rem;display:flex;gap:12px;align-items:center;justify-content:space-between}
  body.theme-light header{background:linear-gradient(180deg,#fff,#f8fafc)} body.theme-bright header{background:linear-gradient(180deg,#fff,#f4f4f5)}
  .brand{display:flex;align-items:center;gap:.6rem;font-weight:700;letter-spacing:.3px}
  .brand .logo{width:32px;height:32px;display:grid;place-items:center;border-radius:9px;background:linear-gradient(135deg,var(--accent),var(--accent2))}
  .brand small{display:block;color:var(--muted);font-weight:500}
  .controls{display:flex;flex-wrap:wrap;gap:.4rem;align-items:center}
  .btn{cursor:pointer;border:1px solid var(--border);color:var(--text);background:var(--panel);padding:.35rem .55rem;border-radius:10px;font-weight:600;font-size:12.5px}
  .btn.toggled{outline:2px solid var(--accent)}
  main{display:grid;grid-template-columns:280px 1fr;gap:12px;padding:12px}
  @media (max-width:1100px){main{grid-template-columns:1fr}.sidebar{position:static}}
  .sidebar{position:sticky;top:64px;align-self:start;display:grid;gap:10px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:9px}
  details.collapsible summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:.4rem;font-weight:700}
  .content-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;align-items:start}
  .category{display:grid;gap:6px} .category h2{margin:0;font-size:13px;color:var(--muted);display:flex;align-items:center;gap:.45rem}
  .tasks{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:6px} .tasks.two-col{grid-template-columns:repeat(2,minmax(210px,1fr))}
  .task-card{background:linear-gradient(180deg, rgba(17,24,39,.85), rgba(2,6,23,.85));border:1px solid var(--border);border-radius:10px;padding:7px;display:grid;gap:5px}
  .task-card.done{opacity:.45;filter:saturate(.6)} .task-head{display:flex;align-items:center;gap:.35rem}
  .task-emoji{font-size:15px} .task-title{font-weight:700;font-size:12.5px} .task-count{margin-left:auto;color:#3b82f6;font-weight:700;font-size:11.5px}
  .progressbar{height:4px;background:transparent;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .progressbar>div{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .log-area{width:100%;height:110px;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:6px;font-size:12px}
  .checklist{display:grid;gap:6px} .cl-row{display:grid;grid-template-columns:auto 1fr auto auto auto;gap:.35rem;align-items:center}
  .cl-title{font-size:12px} .cl-num{width:48px;text-align:center} .tiny{font-size:11px;color:var(--muted)} .soft{border:1px dashed var(--border);border-radius:8px;padding:6px}
  .modal{position:fixed;inset:0;display:none;place-items:center;background:#0006;z-index:100} .modal.show{display:grid}
  .modal .box{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;width:min(680px,92vw);display:grid;gap:8px}
  .timer.running .timer-display{font-size:56px}
  .badge{font-size:11px;border:1px solid var(--border);border-radius:999px;padding:.1rem .4rem;color:var(--muted)}
</style>
</head>
<body class="theme-dark">
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true">ğŸ§­</div>
    <div>Mats Body Reset<br><small>Daily tracker â€¢ <span id="storageMode" class="badge">loadingâ€¦</span> â€¢ local time: <span id="clock"></span></small></div>
  </div>
  <div class="controls">
    <button id="themeToggle" class="btn">ğŸ¨ Mode: Dark</button>
    <button id="atComputerBtn" class="btn">ğŸ’» I'm at the computer</button>
    <label class="btn">ğŸ”” Volume
      <input id="volume" type="range" min="0" max="1" step="0.01" value="0.5" style="vertical-align:middle;width:110px;margin-left:.5rem">
    </label>
    <button id="exportLog" class="btn">ğŸ“¤ Export log</button>
    <button id="downloadToday" class="btn">ğŸ“ Today</button>
    <button id="exportSettings" class="btn">ğŸ§© Save settings</button>
    <button id="importSettings" class="btn">ğŸ§© Load settings</button>
    <button id="linkSettings" class="btn">ğŸ”— Link settings file</button>
    <button id="resetAll" class="btn">â™»ï¸ Full reset</button>
  </div>
</header>

<main>
  <aside class="sidebar">
    <details class="panel collapsible" open>
      <summary>ğŸ” Reminder scheduler</summary>
      <div class="tiny">When the ğŸ’» button is ON, bells will fire according to each task's daily count.</div>
      <div style="display:flex;gap:.35rem;flex-wrap:wrap">
        <button id="startReminders" class="btn">Start</button>
        <button id="stopReminders" class="btn">Stop</button>
        <button id="remindNow" class="btn">Ring now</button>
      </div>
      <div class="tiny" style="margin-top:6px">Next: <span id="nextReminder">â€”</span></div>
    </details>

    <details class="panel collapsible" open>
      <summary>â±ï¸ Trampoline timer</summary>
      <div class="timer" id="timerBox" style="margin-top:.35rem;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center">
        <div class="timer-display" id="timerDisplay" style="font-weight:800;letter-spacing:.6px">03:00</div>
        <div><input id="timerInput" type="number" min="1" max="60" value="3" style="width:64px"> min</div>
      </div>
      <div style="display:flex;gap:.35rem;margin-top:6px">
        <button id="timerStart" class="btn">Start</button>
        <button id="timerPause" class="btn">Pause</button>
        <button id="timerReset" class="btn">Reset</button>
      </div>
    </details>

    <details class="panel collapsible" open>
      <summary>ğŸ“… Daily log (preview)</summary>
      <textarea id="logPreview" class="log-area" readonly style="margin-top:.35rem"></textarea>
    </details>

    <details class="panel collapsible" id="checklistWrap">
      <summary>âœ… Checklist (show/hide, edit, categories)</summary>
      <div class="tiny" style="margin-top:.35rem">Toggle visibility; edit reminders; add/delete tasks & categories. Saves automatically.</div>
      <div style="display:flex;gap:.35rem;flex-wrap:wrap;margin:.35rem 0">
        <button id="addCategory" class="btn">â• New category</button>
        <button id="enableAll" class="btn">Enable all</button>
        <button id="disableAll" class="btn">Disable all</button>
      </div>
      <div id="checklist" class="checklist" style="margin-top:.2rem"></div>
    </details>
  </aside>

  <section class="content-grid" id="grid"></section>
</main>

<div class="modal" id="reminderModal" role="dialog" aria-modal="true">
  <div class="box">
    <div style="font-size:42px;text-align:center">ğŸ””</div>
    <div id="reminderText" style="font-size:18px;font-weight:800;text-align:center">Time for a reset</div>
    <div class="tiny" style="text-align:center">Click a matching task below when you've done it.</div>
    <div id="quickTaskWrap" style="max-height:56vh;overflow:auto;margin-top:6px"></div>
    <div style="display:flex;gap:.35rem;justify-content:center;margin-top:6px">
      <button class="btn" id="modalSnooze">Snooze 5 min</button>
      <button class="btn" id="modalClose">OK</button>
    </div>
  </div>
</div>

<div class="modal" id="editModal" role="dialog" aria-modal="true">
  <div class="box">
    <div style="font-size:16px;font-weight:800" id="editTitle">Add task</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <label>Task name<input id="fName" type="text" required></label>
      <label>Emoji/icon<select id="fEmoji"></select></label>
      <label style="grid-column:1/3">Short description<textarea id="fDesc" rows="2"></textarea></label>
      <label>Counts/day<input id="fCounts" type="number" min="1" value="1"></label>
      <label>Reminders/day<input id="fReminders" type="number" min="0" value="0"></label>
    </div>
    <div style="display:flex;gap:.35rem;justify-content:flex-end;margin-top:6px">
      <button class="btn" id="editCancel">Cancel</button>
      <button class="btn" id="editSave">Save</button>
    </div>
  </div>
</div>

<div class="modal" id="catModal" role="dialog" aria-modal="true">
  <div class="box">
    <div style="font-size:16px;font-weight:800" id="catTitle">New category</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <label>Category name<input id="cName" type="text" required></label>
      <label>Emoji/icon<select id="cEmoji"></select></label>
    </div>
    <div style="display:flex;gap:.35rem;justify-content:flex-end;margin-top:6px">
      <button class="btn" id="catCancel">Cancel</button>
      <button class="btn" id="catSave">Save</button>
    </div>
  </div>
</div>

<script>
// SW with immediate update + auto reload
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./sw.js');
      reg.update();
      setInterval(() => reg.update(), 6 * 60 * 60 * 1000);
      if (reg.waiting) reg.waiting.postMessage('SKIP_WAITING');
      reg.addEventListener('updatefound', () => {
        const sw = reg.installing;
        if (sw) sw.addEventListener('statechange', () => {
          if (sw.state === 'installed' && navigator.serviceWorker.controller) {
            reg.waiting && reg.waiting.postMessage('SKIP_WAITING');
          }
        });
      });
      let refreshed = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshed) return; refreshed = true; window.location.reload();
      });
    } catch (e) {}
  });
}

const LS_KEY='mats_reset_tracker_v7', LOG_KEY='mats_reset_log_v7', ENABLE_KEY='mats_reset_enabled_v7', TASKS_KEY='mats_reset_tasks_v7', CATS_KEY='mats_reset_categories_v7', THEME_KEY='mats_reset_theme_v7';
const EMOJIS=['ğŸŒ€','ğŸŒ¬ï¸','âš¡','ğŸš¶','ğŸ¤¸','ğŸ‘ƒ','ğŸ’†','ğŸ¦¶','ğŸ«','ğŸ‹ï¸','ğŸ¦´','ğŸ¸','ğŸ§ ','ğŸ‘','ğŸ¦–','ğŸ§˜','ğŸ’—','ğŸŒ±','ğŸª¢','ğŸ§·','ğŸ§±','ğŸ¦˜','ğŸƒ','ğŸ¯','â­','â¬¤','â—†','â– ','ğŸ’«','âœ¨','ğŸŸ£','ğŸ”µ','ğŸŸ¢','ğŸŸ '];
function Cat(id,name,emoji,builtin){return {id,name,emoji:emoji||'â­',builtin:!!builtin};}
const BASE_CATS=[Cat('MOVEMENT_AND_RELEASE','Movement & Release','ğŸŒ€',true),Cat('BREATHING_AND_EMOTIONAL_RESET','Breathing & Emotional Reset','ğŸŒ¬ï¸',true),Cat('ACTIVATION','Activation','âš¡',true),Cat('BREAKS_AND_WIGGLES','Breaks & Wiggles','ğŸš¶',true)];
function T(id,title,details,category,countsPerDay,remindersPerDay,emoji,builtin){const cpd=Math.max(1,countsPerDay|0),rpd=Math.max(0,remindersPerDay|0);return {id,title,details,category,countsPerDay:cpd,remindersPerDay:rpd,emoji:emoji||'â€¢',builtin:!!builtin};}
const BASE_TASKS=[
T('symm_move','Symmetrical Movement Stimulation','including star jumps and marching/crawling','MOVEMENT_AND_RELEASE',2,2,'ğŸ¤¸',true),
T('cranial_release','Cranial/Sphenoid Release','Nose blowing with side bend','MOVEMENT_AND_RELEASE',2,2,'ğŸ‘ƒ',true),
T('face_jaw_scalp','Face/Jaw/Scalp Release','Dry shampoo technique','MOVEMENT_AND_RELEASE',2,2,'ğŸ’†',true),
T('ankle_release','Ankle Release','Partnerâ€‘assisted','MOVEMENT_AND_RELEASE',1,0,'ğŸ¦¶',true),
T('rib_lifts','Rib Lifts','Partnerâ€‘assisted','MOVEMENT_AND_RELEASE',1,1,'ğŸ«',true),
T('deadlift_motion','"Deadlift" (motions)','Form only, no load','MOVEMENT_AND_RELEASE',2,2,'ğŸ‹ï¸',true),
T('hip_reset','Hip reset','Hip release/reset','MOVEMENT_AND_RELEASE',2,2,'ğŸ¦´',true),
T('frog_legs','Frog Legs','Gentle open/close hips','MOVEMENT_AND_RELEASE',1,0,'ğŸ¸',true),
T('meningeal_stretch','Meningeal Stretch','Along spine','MOVEMENT_AND_RELEASE',1,0,'ğŸ§ ',true),
T('rubbing_sacrum','Rubbing sacrum + bend','Activate glutes','MOVEMENT_AND_RELEASE',3,3,'ğŸ‘',true),
T('spiky_ball','Spiky ball / foot sole','Curl toes, press sole','MOVEMENT_AND_RELEASE',1,1,'ğŸ¦–',true),
T('vagus_on','Vagus nerve â€œOnâ€ â€“ Chin up','Short resets across the day','BREATHING_AND_EMOTIONAL_RESET',8,8,'ğŸ§˜',true),
T('emotional_diaphragm','Emotional/Diaphragm Release','Meditation, compassion, let go','BREATHING_AND_EMOTIONAL_RESET',1,1,'ğŸ’—',true),
T('ergo_more_life','Ergo for More Life','Breath/ergonomics cue','BREATHING_AND_EMOTIONAL_RESET',1,0,'ğŸŒ±',true),
T('band_exercises','Band Exercises','Front pull, rotation, above, push','ACTIVATION',2,2,'ğŸª¢',true),
T('neck_reset','Neck Muscle Resetting','Head lift + rub; push into mat','ACTIVATION',1,1,'ğŸ§·',true),
T('ab_ing_reset','Abdominal/Inguinal Resetting','Stomach rub â€“ positions','ACTIVATION',2,2,'ğŸŒ€',true),
T('stomach_activation','Stomach Muscles Activation','Core activation cues','ACTIVATION',1,0,'ğŸ§±',true),
T('trampoline','Trampoline','3 minutes â€“ use timer','ACTIVATION',3,3,'ğŸ¦˜',true),
T('walk_jog','Walk / Jog','Regular short breaks','BREAKS_AND_WIGGLES',1,1,'ğŸƒ',true),
T('wiggle_hit','Wiggle & Hit','Shake it out, tap','BREAKS_AND_WIGGLES',1,0,'ğŸ¯',true),
];

// IDB tiny KV for file handle
const idbKV={db:null,async open(){if(this.db) return this.db; this.db=await new Promise((res,rej)=>{const req=indexedDB.open('mats-reset-idb',1); req.onupgradeneeded=()=>req.result.createObjectStore('kv'); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error);}); return this.db;},
  async get(key){const db=await this.open(); return new Promise((res,rej)=>{const tx=db.transaction('kv','readonly'); const st=tx.objectStore('kv'); const r=st.get(key); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);});},
  async set(key,val){const db=await this.open(); return new Promise((res,rej)=>{const tx=db.transaction('kv','readwrite'); const st=tx.objectStore('kv'); const r=st.put(val,key); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error);});} };

// Storage selection (OPFS auto > linked file > LocalStorage)
const storageBadge=document.getElementById('storageMode');
async function opfsSupported(){return !!(navigator.storage && navigator.storage.getDirectory);}
async function opfsReadText(){try{const root=await navigator.storage.getDirectory(); const fh=await root.getFileHandle('settings.json',{create:false}); const f=await fh.getFile(); return await f.text();}catch(e){return null;}}
async function opfsWriteText(text){try{const root=await navigator.storage.getDirectory(); const fh=await root.getFileHandle('settings.json',{create:true}); const ws=await fh.createWritable(); await ws.write(text); await ws.close(); return true;}catch(e){return false;}}
let fileHandle=null; async function loadLinkedHandle(){try{fileHandle=await idbKV.get('settingsHandle');}catch(e){fileHandle=null;}}
async function fsReadText(){if(!fileHandle) return null; try{const f=await fileHandle.getFile(); return await f.text();}catch(e){return null;}}
async function fsWriteText(text){if(!fileHandle) return false; try{const perm=await fileHandle.requestPermission({mode:'readwrite'}); if(perm!=='granted') return false; const ws=await fileHandle.createWritable(); await ws.write(text); await ws.close(); return true;}catch(e){return false;}}
async function linkSettingsFile(){
  if(!window.showSaveFilePicker){ alert('Linking requires a Chromium browser (File System Access API).'); return; }
  const handle=await window.showSaveFilePicker({ suggestedName:'settings.json', types:[{description:'JSON',accept:{'application/json':['.json']}}] });
  await idbKV.set('settingsHandle', handle); fileHandle=handle; storageBadge.textContent='Linked File'; alert('Linked settings.json. Saves/loads will use this file.');
}
function currentSettingsPayload(){ return JSON.stringify({ tasks: loadTaskStore(), categories: loadCatStore(), enabled: state.enabled, theme: loadTheme() }, null, 2); }
async function autoLoadSettingsFromFile(){
  if(await opfsSupported()){ const txt=await opfsReadText(); if(txt){ applySettingsJSON(txt); storageBadge.textContent='OPFS (auto)'; return; } storageBadge.textContent='OPFS (auto)'; return; }
  await loadLinkedHandle(); if(fileHandle){ const txt=await fsReadText(); if(txt){ applySettingsJSON(txt); storageBadge.textContent='Linked File'; return; } storageBadge.textContent='Linked File'; return; }
  storageBadge.textContent='LocalStorage';
}
async function autoSaveSettingsToFile(){ const json=currentSettingsPayload(); if(await opfsSupported()){ await opfsWriteText(json); return; } await loadLinkedHandle(); if(fileHandle){ await fsWriteText(json); return; } }

document.getElementById('exportSettings').onclick=async()=>{ await autoSaveSettingsToFile(); alert('Settings saved.'); };
document.getElementById('importSettings').onclick=async()=>{ await autoLoadSettingsFromFile(); renderChecklist(); render(); alert('Settings loaded.'); };
document.getElementById('linkSettings').onclick=linkSettingsFile;

// Core stores
function loadTaskStore(){let s={overrides:{},customs:[]}; try{s=JSON.parse(localStorage.getItem(TASKS_KEY)||'{}')||s;}catch(e){} if(!s.overrides) s.overrides={}; if(!Array.isArray(s.customs)) s.customs=[]; return s;}
function saveTaskStore(s){localStorage.setItem(TASKS_KEY, JSON.stringify(s)); autoSaveSettingsToFile();}
function loadCatStore(){let s={overrides:{},customs:[]}; try{s=JSON.parse(localStorage.getItem(CATS_KEY)||'{}')||s;}catch(e){} if(!s.overrides) s.overrides={}; if(!Array.isArray(s.customs)) s.customs=[]; return s;}
function saveCatStore(s){localStorage.setItem(CATS_KEY, JSON.stringify(s)); autoSaveSettingsToFile();}
function getCategories(){const cs=loadCatStore(); const base=BASE_CATS.map(c=>cs.overrides[c.id]?{...c,...cs.overrides[c.id]}:c).filter(c=>!cs.overrides[c.id]?.deleted); const customs=cs.customs.filter(c=>!c.deleted); return [...base,...customs];}
function getCategoryById(id){return getCategories().find(c=>c.id===id);}
function getTasks(){const ts=loadTaskStore(); const catIds=new Set(getCategories().map(c=>c.id)); const base=BASE_TASKS.map(t=>ts.overrides[t.id]?{...t,...ts.overrides[t.id]}:t).filter(t=>!ts.overrides[t.id]?.removed && catIds.has(t.category)); const customs=ts.customs.filter(t=>!t.removed && catIds.has(t.category)); return [...base,...customs];}
function getTaskById(id){return getTasks().find(t=>t.id===id);}
function loadEnabled(){let raw={}; try{raw=JSON.parse(localStorage.getItem(ENABLE_KEY)||'{}')||{};}catch(e){raw={}} getTasks().forEach(t=>{if(!(t.id in raw)) raw[t.id]=true;}); localStorage.setItem(ENABLE_KEY, JSON.stringify(raw)); return raw;}
function saveEnabled(map){localStorage.setItem(ENABLE_KEY, JSON.stringify(map)); autoSaveSettingsToFile();}
function todayKey(){const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function loadPersist(){let raw={}; try{raw=JSON.parse(localStorage.getItem(LS_KEY)||'{}')||{};}catch(e){} const key=todayKey(); if(!raw[key]){const tasks={}; getTasks().forEach(t=>tasks[t.id]={done:0}); raw[key]={atComputer:false,tasks};} const tasks=raw[key].tasks; getTasks().forEach(t=>{if(!tasks[t.id]) tasks[t.id]={done:0};}); localStorage.setItem(LS_KEY, JSON.stringify(raw)); return raw;}
function savePersist(raw){localStorage.setItem(LS_KEY, JSON.stringify(raw));}
const gridEl=document.getElementById('grid'), checklistEl=document.getElementById('checklist'), quickTaskWrap=document.getElementById('quickTaskWrap');
const state={enabled:{},schedule:[],timers:[],atComputer:false};
function loadTheme(){return localStorage.getItem(THEME_KEY)||'dark';} function saveTheme(t){localStorage.setItem(THEME_KEY,t); applyTheme(t); autoSaveSettingsToFile();}
function applyTheme(t){document.body.className=''; document.body.classList.add('theme-'+t); document.getElementById('themeToggle').textContent='ğŸ¨ Mode: '+(t==='dark'?'Dark':t==='light'?'Light':'Bright');}

// Checklist
function renderChecklist(){
  const cats=getCategories(), tasks=getTasks(), enabled=state.enabled; checklistEl.innerHTML='';
  cats.forEach(cat=>{
    const bar=document.createElement('div'); bar.className='cl-row soft';
    bar.innerHTML=`<div><strong>${cat.emoji}</strong></div><div class="cl-title"><strong>${cat.name}</strong></div>
      <div class="tiny" style="justify-self:end;grid-column:3/6">
        <button class="btn" data-cat-edit="${cat.id}">âœï¸ Edit</button>
        <button class="btn" data-cat-del="${cat.id}">ğŸ—‘ï¸ Delete</button>
        <button class="btn" data-cat-add="${cat.id}">â• Add item</button>
      </div>`;
    checklistEl.appendChild(bar);
    const header=document.createElement('div'); header.className='cl-row tiny';
    header.innerHTML=`<span></span><span class="tiny">Task</span><span class="tiny" style="justify-self:end">Reminders</span><span class="tiny" style="justify-self:end">Edit</span><span class="tiny" style="justify-self:end">Delete</span>`;
    checklistEl.appendChild(header);

    tasks.filter(t=>t.category===cat.id).forEach(t=>{
      const row=document.createElement('div'); row.className='cl-row';
      row.innerHTML=`
      <input type="checkbox" ${enabled[t.id]!==false?'checked':''} data-id="${t.id}">
      <span class="cl-title">${t.title}</span>
      <input class="cl-num" type="number" min="0" value="${t.remindersPerDay}" data-id="${t.id}" data-field="remindersPerDay">
      <button class="btn" data-action="edit" data-id="${t.id}">âœï¸</button>
      <button class="btn" data-action="delete" data-id="${t.id}" ${(t.builtin)?'':'style="border-color:#b91c1c"'}>ğŸ—‘ï¸</button>`;
      checklistEl.appendChild(row);
    });
  });

  checklistEl.querySelectorAll('input[type="checkbox"]').forEach(chk=>{ chk.onchange=()=>{ state.enabled[chk.dataset.id]=chk.checked; saveEnabled(state.enabled); render(); }; });
  checklistEl.querySelectorAll('input[type="number"]').forEach(num=>{ num.onchange=()=>{ const id=num.dataset.id; const val=Math.max(0, parseInt(num.value,10)||0); updateTaskField(id,'remindersPerDay',val); }; });
  checklistEl.querySelectorAll('button[data-action="edit"]').forEach(b=>b.onclick=()=>openEditModal(getTaskById(b.dataset.id)));
  checklistEl.querySelectorAll('button[data-action="delete"]').forEach(b=>b.onclick=()=>deleteTask(b.dataset.id));
  checklistEl.querySelectorAll('button[data-cat-add]').forEach(b=>b.onclick=()=>openEditModal({category:b.dataset.catAdd}));
  checklistEl.querySelectorAll('button[data-cat-edit]').forEach(b=>b.onclick=()=>openCatModal(getCategoryById(b.dataset.catEdit)));
  checklistEl.querySelectorAll('button[data-cat-del]').forEach(b=>b.onclick=()=>deleteCategory(b.dataset.catDel));
}
function updateTaskField(id,field,value){
  const store=loadTaskStore(); if(BASE_TASKS.find(t=>t.id===id)){ store.overrides[id]={...(store.overrides[id]||{}), [field]:value}; } else {
    const i=store.customs.findIndex(t=>t.id===id); if(i>=0){ store.customs[i][field]=value; }
  } saveTaskStore(store); render();
}

// Task Add/Edit/Delete
let editContext={mode:'add', id:null, category:null};
const editModal=document.getElementById('editModal'); const fEmoji=document.getElementById('fEmoji');
function populateEmojiSelect(sel){ sel.innerHTML=''; EMOJIS.forEach(e=>{ const o=document.createElement('option'); o.textContent=e; sel.appendChild(o); }); }
populateEmojiSelect(fEmoji);
function openEditModal(task){
  editContext={mode: task&&task.id ? (task.builtin?'edit-override':'edit') : 'add', id: task&&task.id || null, category: task&&task.category || null};
  document.getElementById('editTitle').textContent = editContext.mode==='add' ? 'Add task' : 'Edit task';
  document.getElementById('fName').value = task?.title || '';
  document.getElementById('fEmoji').value = task?.emoji || 'â­';
  document.getElementById('fDesc').value = task?.details || '';
  document.getElementById('fCounts').value = task?.countsPerDay || 1;
  document.getElementById('fReminders').value = task?.remindersPerDay ?? 0;
  editModal.classList.add('show');
}
document.getElementById('editCancel').onclick=()=>editModal.classList.remove('show');
document.getElementById('editSave').onclick=()=>{
  const title=document.getElementById('fName').value.trim();
  const emoji=document.getElementById('fEmoji').value;
  const details=document.getElementById('fDesc').value.trim();
  const counts=Math.max(1,parseInt(document.getElementById('fCounts').value,10)||1);
  const reminders=Math.max(0,parseInt(document.getElementById('fReminders').value,10)||0);
  if(!title){ alert('Please enter a task name.'); return; }
  const store=loadTaskStore();
  if(editContext.mode==='add'){
    const id='custom_'+Date.now();
    const category = editContext.category || getCategories()[0].id;
    store.customs.push({id,title,details,category,countsPerDay:counts,remindersPerDay:reminders,emoji,builtin:false});
  }else{
    if(BASE_TASKS.find(t=>t.id===editContext.id)){
      store.overrides[editContext.id]={...(store.overrides[editContext.id]||{}), title, details, countsPerDay:counts, remindersPerDay:reminders, emoji};
    }else{
      const i=store.customs.findIndex(t=>t.id===editContext.id);
      if(i>=0){ Object.assign(store.customs[i], {title,details,countsPerDay:counts,remindersPerDay:reminders,emoji}); }
    }
  }
  saveTaskStore(store);
  editModal.classList.remove('show');
  const raw=loadPersist(); const key=todayKey(); const today=raw[key];
  getTasks().forEach(t=>{ if(!today.tasks[t.id]) today.tasks[t.id]={done:0}; });
  raw[key]=today; savePersist(raw);
  state.enabled=loadEnabled();
  renderChecklist(); render();
};
function deleteTask(id){
  if(!confirm('Delete this task?')) return;
  const store=loadTaskStore();
  const baseIndex = BASE_TASKS.findIndex(t=>t.id===id);
  if(baseIndex>=0){
    store.overrides[id]={...(store.overrides[id]||{}), removed:true};
  } else {
    const i=store.customs.findIndex(t=>t.id===id);
    if(i>=0){ store.customs.splice(i,1); }
  }
  saveTaskStore(store);
  const raw=loadPersist(); const key=todayKey(); if(raw[key] && raw[key].tasks){ delete raw[key].tasks[id]; savePersist(raw); }
  const en=loadEnabled(); if(en && en.hasOwnProperty(id)){ delete en[id]; saveEnabled(en); state.enabled=en; }
  renderChecklist(); render();
}

// Categories
let catCtx={mode:'add', id:null};
const catModal=document.getElementById('catModal'); const cEmoji=document.getElementById('cEmoji');
populateEmojiSelect(cEmoji);
function openCatModal(cat){
  catCtx={mode: cat&&cat.id ? (cat.builtin?'edit-override':'edit') : 'add', id: cat&&cat.id || null};
  document.getElementById('catTitle').textContent = catCtx.mode==='add' ? 'New category' : 'Edit category';
  document.getElementById('cName').value = cat?.name || '';
  document.getElementById('cEmoji').value = cat?.emoji || 'â­';
  catModal.classList.add('show');
}
document.getElementById('catCancel').onclick=()=>catModal.classList.remove('show');
document.getElementById('catSave').onclick=()=>{
  const name=document.getElementById('cName').value.trim();
  const emoji=document.getElementById('cEmoji').value;
  if(!name){ alert('Please enter a category name.'); return; }
  const store=loadCatStore();
  if(catCtx.mode==='add'){
    const id='cat_'+Date.now();
    store.customs.push({id,name,emoji,builtin:false});
  }else{
    if(BASE_CATS.find(c=>c.id===catCtx.id)){
      store.overrides[catCtx.id]={...(store.overrides[catCtx.id]||{}), name, emoji};
    }else{
      const i=store.customs.findIndex(c=>c.id===catCtx.id);
      if(i>=0) Object.assign(store.customs[i], {name,emoji});
    }
  }
  saveCatStore(store);
  catModal.classList.remove('show');
  renderChecklist(); render();
};
function deleteCategory(id){
  if(!confirm('Delete this category and all its tasks?')) return;
  const cstore=loadCatStore();
  if(BASE_CATS.find(c=>c.id===id)){
    cstore.overrides[id]={...(cstore.overrides[id]||{}), deleted:true};
  }else{
    const i=cstore.customs.findIndex(c=>c.id===id); if(i>=0) cstore.customs.splice(i,1);
  }
  saveCatStore(cstore);
  const tstore=loadTaskStore();
  BASE_TASKS.filter(t=>t.category===id).forEach(t=>{ tstore.overrides[t.id]={...(tstore.overrides[t.id]||{}), removed:true}; });
  tstore.customs = tstore.customs.filter(t=>t.category!==id);
  saveTaskStore(tstore);
  const raw=loadPersist(); const key=todayKey(); const today=raw[key];
  Object.keys(today.tasks).forEach(tid=>{ const tt=getTaskById(tid); if(!tt || tt.category===id){ delete today.tasks[tid]; } });
  raw[key]=today; savePersist(raw);
  const en=loadEnabled(); Object.keys(en).forEach(id2=>{ const t=getTaskById(id2); if(!t){ delete en[id2]; } }); saveEnabled(en); state.enabled=en;
  renderChecklist(); render();
}

// Render
function render(){
  document.getElementById('clock').textContent=new Date().toLocaleTimeString();
  document.getElementById('logPreview').value=buildDayReport();
  const today=getToday(); state.atComputer=today.atComputer; document.getElementById('atComputerBtn').classList.toggle('toggled',state.atComputer);
  const cats=getCategories(); const tasks=getTasks(); gridEl.innerHTML='';
  cats.forEach(cat=>{
    const catWrap=document.createElement('div'); catWrap.className='category panel';
    catWrap.innerHTML=`<h2>${cat.emoji} ${cat.name}</h2>`;
    const list=document.createElement('div'); list.className='tasks'; if(cat.id==='MOVEMENT_AND_RELEASE') list.classList.add('two-col');
    tasks.filter(t=>t.category===cat.id && state.enabled[t.id]!==false).forEach(task=>{
      const today=getToday(); const done=today.tasks[task.id]?.done||0; const pct=Math.min(100,Math.round(100*done/task.countsPerDay)); const finished=done>=task.countsPerDay;
      const card=document.createElement('div'); card.className='task-card'+(finished?' done':'');
      card.innerHTML=`<div class="task-head"><div class="task-emoji">${task.emoji}</div><div class="task-title">${task.title}</div><div class="task-count">${done}/${task.countsPerDay}</div></div>
        <div class="progressbar"><div style="width:${pct}%"></div></div>
        <div class="actions"><button class="btn do-btn" data-id="${task.id}">âœ”ï¸ I did this now</button> <span class="tiny">Reminders: ${task.remindersPerDay}</span></div>`;
      list.appendChild(card);
    });
    catWrap.appendChild(list); gridEl.appendChild(catWrap);
  });
  document.querySelectorAll('.do-btn').forEach(btn=>btn.onclick=()=>incrementTask(btn.dataset.id));
}

// Quick list grouped by category
function renderQuickList(){
  const cats=getCategories(); const tasks=getTasks(); const today=getToday();
  quickTaskWrap.innerHTML='';
  cats.forEach(cat=>{
    const group=document.createElement('div'); group.className='soft'; group.style.marginBottom='6px';
    const title=document.createElement('div'); title.className='tiny'; title.style.fontWeight='800'; title.textContent = cat.emoji + ' ' + cat.name;
    group.appendChild(title);
    const row=document.createElement('div'); row.style.display='flex'; row.style.flexWrap='wrap'; row.style.gap='.3rem';
    tasks.filter(t=>t.category===cat.id && state.enabled[t.id]!==false).forEach(t=>{
      const done=today.tasks[t.id]?.done||0; const doneAll=done>=t.countsPerDay;
      const b=document.createElement('button'); b.className='btn'+(doneAll?'':''); b.textContent=t.title; if(doneAll){ b.disabled=true; b.style.opacity=.6; }
      else{ b.onclick=()=>{ incrementTask(t.id); hideReminder(); }; }
      row.appendChild(b);
    });
    group.appendChild(row); quickTaskWrap.appendChild(group);
  });
}
function incrementTask(id){
  setToday(day=>{
    const d=JSON.parse(JSON.stringify(day)); if(!d.tasks[id]) d.tasks[id]={done:0};
    const t=getTaskById(id); const max=t?t.countsPerDay:1; d.tasks[id].done=Math.min((d.tasks[id].done||0)+1,max); return d;
  });
}

// Timer & audio
let timerInt=null, timerRemaining=180; const timerDisplay=document.getElementById('timerDisplay'); const timerInput=document.getElementById('timerInput'); const timerBox=document.getElementById('timerBox');
function fmt(s){const m=Math.floor(s/60).toString().padStart(2,'0');const ss=(s%60).toString().padStart(2,'0');return `${m}:${ss}`;}
function updateTimerUI(){ timerDisplay.textContent=fmt(timerRemaining); }
function startTimer(){ ensureAudio(); if(timerInt) return; timerBox.classList.add('running'); timerInt=setInterval(()=>{ if(--timerRemaining<=0){ clearInterval(timerInt); timerInt=null; timerBox.classList.remove('running'); chime(); showReminder('Trampoline timer done â€“ nice!'); timerRemaining=Math.max(60,parseInt(timerInput.value,10)*60||180); updateTimerUI(); } else updateTimerUI(); },1000); }
function pauseTimer(){ if(timerInt){ clearInterval(timerInt); timerInt=null; timerBox.classList.remove('running'); } }
function resetTimer(){ pauseTimer(); timerRemaining=Math.max(60,parseInt(timerInput.value,10)*60||180); updateTimerUI(); }
let actx=null, masterGain=null; const volume=document.getElementById('volume');
function ensureAudio(){ if(!actx){ actx=new (window.AudioContext||window.webkitAudioContext)(); masterGain=actx.createGain(); masterGain.gain.value=parseFloat(volume.value||0.5); masterGain.connect(actx.destination); } if(actx.state==='suspended'){ actx.resume(); } }
volume.addEventListener('input',()=>{ if(masterGain) masterGain.gain.value=parseFloat(volume.value||0.5); });
function bellVoice(t,f,d){ const o=actx.createOscillator(), g=actx.createGain(), o2=actx.createOscillator(), g2=actx.createGain(); o.type='sine'; o.frequency.setValueAtTime(f,t); o2.type='sine'; o2.frequency.setValueAtTime(f*2.01,t); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.6,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+d); g2.gain.setValueAtTime(0.0001,t); g2.gain.exponentialRampToValueAtTime(0.25,t+0.02); g2.gain.exponentialRampToValueAtTime(0.0001,t+d*0.9); o.connect(g); o2.connect(g2); g.connect(masterGain); g2.connect(masterGain); o.start(t); o.stop(t+d+0.05); o2.start(t); o2.stop(t+d+0.05); }
function chime(){ try{ ensureAudio(); const t=actx.currentTime+0.01; bellVoice(t,880,1.2); bellVoice(t+0.25,1318.51,1.0);}catch(e){} }

// Reminders
const modal=document.getElementById('reminderModal'); const nextReminderEl=document.getElementById('nextReminder');
function showReminder(text){ document.getElementById('reminderText').textContent=text||'Time for a reset'; renderQuickList(); modal.classList.add('show'); }
function hideReminder(){ modal.classList.remove('show'); }
document.getElementById('modalClose').onclick=hideReminder; document.getElementById('modalSnooze').onclick=()=>{ hideReminder(); scheduleIn(5*60); };
function buildSchedule(){ const now=new Date(); const secsToMid=((new Date(now.getFullYear(),now.getMonth(),now.getDate()+1))-now)/1000; const slots=[]; getTasks().forEach(t=>{ if(state.enabled[t.id]===false) return; if(t.remindersPerDay>0){ const gap=secsToMid/(t.remindersPerDay+1); for(let i=1;i<=t.remindersPerDay;i++){ const at=now.getTime()+(gap*i*1000); slots.push({at,task:t}); } } }); slots.sort((a,b)=>a.at-b.at); state.schedule=slots; }
function scheduleRunner(){ clearAllTimeouts(); if(!state.atComputer){ nextReminderEl.textContent='â€” (not at computer)'; return; } const now=Date.now(); let first=null; state.schedule.forEach(slot=>{ const delay=Math.max(0,slot.at-now); const id=setTimeout(()=>{ if(!state.atComputer) return; chime(); showReminder(`Time for: ${slot.task.title}`); },delay); state.timers.push(id); if(first===null||slot.at<first) first=slot.at; }); if(first){ nextReminderEl.textContent=new Date(first).toLocaleTimeString(); } }
function clearAllTimeouts(){ state.timers.forEach(id=>clearTimeout(id)); state.timers=[]; }
function scheduleIn(seconds){ clearAllTimeouts(); const at=Date.now()+seconds*1000; state.schedule=[{at,task:{title:'Snoozed reminder'}}]; scheduleRunner(); }

// Reports/rollover
function buildDayReport(){ const d=new Date(); const today=getToday(); const tasks=getTasks(); let out='# '+d.toDateString()+'\n'; tasks.forEach(t=>{ const done=today.tasks[t.id]?.done||0; out+='- '+t.title+': '+done+'/'+t.countsPerDay+'\n'; }); return out; }
function appendDailyToLog(){ const entry=buildDayReport()+'\n'; const all=(localStorage.getItem(LOG_KEY)||'')+entry; localStorage.setItem(LOG_KEY,all); }
function download(filename,text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; a.click(); }
function setMidnightRollover(){ const now=new Date(); const ms=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,2)-now;
  setTimeout(()=>{ appendDailyToLog(); const raw=loadPersist(); const key=todayKey(); const tasks={}; getTasks().forEach(t=>tasks[t.id]={done:0}); raw[key]={atComputer:false,tasks}; savePersist(raw); buildSchedule(); scheduleRunner(); render(); setMidnightRollover(); }, ms);
}

// Top bar
document.getElementById('atComputerBtn').onclick=()=>{ ensureAudio(); setToday(day=>{const d=JSON.parse(JSON.stringify(day)); d.atComputer=!d.atComputer; return d;}); };
document.getElementById('exportLog').onclick=()=>download('mats-reset-log.txt',localStorage.getItem(LOG_KEY)||'');
document.getElementById('downloadToday').onclick=()=>download(`mats-reset-${todayKey()}.txt`,buildDayReport());
document.getElementById('resetAll').onclick=()=>{ if(confirm('Full reset? Clears counts & logs (keeps tasks/categories/checklist).')){ clearAllTimeouts(); localStorage.removeItem(LOG_KEY); localStorage.removeItem(LS_KEY); loadPersist(); buildSchedule(); scheduleRunner(); render(); alert('Counts & logs reset.'); } };
document.getElementById('themeToggle').onclick=()=>{ const cur=loadTheme(); const next=cur==='dark'?'light':cur==='light'?'bright':'dark'; saveTheme(next); };

// Sidebar buttons
document.getElementById('enableAll').onclick=()=>{ const en=loadEnabled(); getTasks().forEach(t=>en[t.id]=true); saveEnabled(en); state.enabled=en; renderChecklist(); render(); };
document.getElementById('disableAll').onclick=()=>{ const en=loadEnabled(); getTasks().forEach(t=>en[t.id]=false); saveEnabled(en); state.enabled=en; renderChecklist(); render(); };
document.getElementById('addCategory').onclick=()=>openCatModal(null);

// Reminder controls
document.getElementById('startReminders').onclick=()=>{ ensureAudio(); buildSchedule(); scheduleRunner(); };
document.getElementById('stopReminders').onclick=()=>{ clearAllTimeouts(); nextReminderEl.textContent='â€” stopped'; };
document.getElementById('remindNow').onclick=()=>{ ensureAudio(); chime(); showReminder('Gentle reminder to do a task now'); };

// Timer controls
document.getElementById('timerStart').onclick=startTimer;
document.getElementById('timerPause').onclick=pauseTimer;
document.getElementById('timerReset').onclick=resetTimer;
document.getElementById('timerInput').addEventListener('change', resetTimer);

// Persist helpers
function getToday(){ return loadPersist()[todayKey()]; }
function setToday(updater){ const raw=loadPersist(); const key=todayKey(); raw[key]=updater(raw[key]); savePersist(raw); render(); }

// Apply settings JSON
function applySettingsJSON(txt){
  try{
    const payload=JSON.parse(txt);
    if(payload.tasks) localStorage.setItem(TASKS_KEY, JSON.stringify(payload.tasks));
    if(payload.categories) localStorage.setItem(CATS_KEY, JSON.stringify(payload.categories));
    if(payload.enabled) localStorage.setItem(ENABLE_KEY, JSON.stringify(payload.enabled));
    if(payload.theme){ localStorage.setItem(THEME_KEY, payload.theme); applyTheme(payload.theme); }
  }catch(e){ console.warn('Bad settings.json', e); }
}

// Init
function applyTheme(t){document.body.className=''; document.body.classList.add('theme-'+t); document.getElementById('themeToggle').textContent='ğŸ¨ Mode: '+(t==='dark'?'Dark':t==='light'?'Light':'Bright');}
applyTheme(loadTheme());
state.enabled = loadEnabled();
document.getElementById('checklistWrap').open = false;
autoLoadSettingsFromFile().then(()=>{ state.enabled=loadEnabled(); renderChecklist(); render(); });
resetTimer();
setInterval(()=>{ document.getElementById('clock').textContent=new Date().toLocaleTimeString(); },1000);
setMidnightRollover();
</script>
</body>
</html>
